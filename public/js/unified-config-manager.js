/**
 * ========================================================================
 * GESTIONNAIRE DE CONFIGURATION UNIFI√â - SGLP v2.1
 * Centralise la gestion des URLs et configurations
 * ‚úÖ MISE √Ä JOUR: Am√©lioration d√©tection et fallbacks
 * ========================================================================
 */

window.UnifiedConfigManager = {
    
    // Configuration centralis√©e
    config: {
        debug: true,
        initialized: false,
        version: '2.1-MISE-A-JOUR',
        endpoints: {
            // Workflow
            storePhase1: null,
            adherentsImport: null,
            confirmation: null,
            
            // Chunking
            processChunk: null,
            refreshCSRF: null,
            healthCheck: null,
            
            // Templates
            templateDownload: null,
            storeAdherents: null
        }
    },
    
    /**
     * ‚úÖ INITIALISATION DEPUIS PHASE2CONFIG - AM√âLIOR√âE
     */
    initializeFromPhase2Config() {
        this.log('üîß Initialisation depuis Phase2Config v2.1...');
        
        if (typeof window.Phase2Config === 'undefined') {
            this.log('‚ö†Ô∏è Phase2Config non disponible, fallback...');
            this.initializeFallback();
            return false;
        }
        
        try {
            // URLs principales - AM√âLIORATION: V√©rification plus robuste
            if (window.Phase2Config.urls) {
                const urls = window.Phase2Config.urls;
                
                this.config.endpoints.processChunk = urls.processChunk || urls.process_chunk;
                this.config.endpoints.refreshCSRF = urls.refreshCSRF || urls.refresh_csrf;
                this.config.endpoints.healthCheck = urls.healthCheck || urls.health_check;
                this.config.endpoints.storeAdherents = urls.storeAdherents || urls.store_adherents;
                this.config.endpoints.confirmation = urls.confirmation;
                this.config.endpoints.templateDownload = urls.templateDownload || urls.template_download;
                this.config.endpoints.storePhase1 = urls.storePhase1 || urls.store_phase1;
                
                this.log('‚úÖ URLs Phase2Config d√©tect√©es:', Object.keys(urls));
            }
            
            // Configuration chunking
            if (window.Phase2Config.upload) {
                this.config.chunking = {
                    chunkSize: window.Phase2Config.upload.chunkSize || 500,
                    threshold: window.Phase2Config.upload.chunkingThreshold || 200,
                    maxRetries: window.Phase2Config.upload.maxRetries || 3,
                    timeoutPerChunk: window.Phase2Config.upload.timeoutPerChunk || 30000
                };
                this.log('‚úÖ Configuration chunking initialis√©e');
            }
            
            // M√©tadonn√©es
            this.config.dossier = {
                id: window.Phase2Config.dossierId,
                organisationId: window.Phase2Config.organisationId
            };
            
            this.config.initialized = true;
            this.log('‚úÖ Configuration initialis√©e depuis Phase2Config');
            
            // Mise √† jour imm√©diate des configs existantes
            this.updateExistingConfigs();
            
            return true;
            
        } catch (error) {
            this.log('‚ùå Erreur initialisation Phase2Config:', error);
            this.initializeFallback();
            return false;
        }
    },
    
    /**
     * ‚úÖ INITIALISATION FALLBACK - AM√âLIOR√âE
     */
    initializeFallback() {
        this.log('üîÑ Initialisation fallback v2.1...');
        
        const currentDossierId = this.getCurrentDossierId();
        
        this.config.endpoints = {
            // Chunking
            processChunk: '/operator/chunking/process-chunk',
            refreshCSRF: '/csrf-token', // ‚úÖ CORRECTION: URL simplifi√©e
            healthCheck: '/operator/chunking/health',
            
            // Workflow
            storePhase1: '/operator/organisations/store-phase1',
            storeAdherents: `/operator/dossiers/${currentDossierId}/store-adherents`,
            confirmation: `/operator/dossiers/${currentDossierId}/confirmation`,
            adherentsImport: `/operator/dossiers/${currentDossierId}/adherents-import`,
            
            // Templates
            templateDownload: '/operator/templates/adherents-excel'
        };
        
        this.config.chunking = {
            chunkSize: 500,
            threshold: 200,
            maxRetries: 3,
            timeoutPerChunk: 30000
        };
        
        this.config.dossier = {
            id: currentDossierId,
            organisationId: null
        };
        
        this.config.initialized = true;
        this.log('‚úÖ Configuration fallback initialis√©e pour dossier:', currentDossierId);
    },
    
    /**
     * ‚úÖ OBTENIR L'ID DU DOSSIER ACTUEL - AM√âLIOR√â
     */
    getCurrentDossierId() {
        // Source 1: Phase2Config
        if (window.Phase2Config?.dossierId) {
            this.log('üìç Dossier ID depuis Phase2Config:', window.Phase2Config.dossierId);
            return window.Phase2Config.dossierId;
        }
        
        // Source 2: Meta tag
        const metaDossier = document.querySelector('meta[name="dossier-id"]');
        if (metaDossier) {
            const id = metaDossier.getAttribute('content');
            this.log('üìç Dossier ID depuis meta tag:', id);
            return id;
        }
        
        // Source 3: URL actuelle - AM√âLIORATION: Patterns multiples
        const patterns = [
            /\/dossiers\/(\d+)/,
            /\/operator\/dossiers\/(\d+)/,
            /dossier[_-]?id[=:](\d+)/i
        ];
        
        for (const pattern of patterns) {
            const match = window.location.pathname.match(pattern) || 
                         window.location.search.match(pattern);
            if (match) {
                const id = match[1];
                this.log('üìç Dossier ID depuis URL:', id);
                return id;
            }
        }
        
        // Source 4: Session/Local storage
        const sessionId = sessionStorage.getItem('current_dossier_id') || 
                         localStorage.getItem('current_dossier_id');
        if (sessionId) {
            this.log('üìç Dossier ID depuis storage:', sessionId);
            return sessionId;
        }
        
        // Fallback
        this.log('‚ö†Ô∏è Dossier ID non trouv√©, utilisation fallback: 1');
        return '1';
    },
    
    /**
     * ‚úÖ OBTENIR UNE URL ENDPOINT - AM√âLIOR√â
     */
    getEndpoint(name) {
        if (!this.config.initialized) {
            this.initializeFromPhase2Config();
        }
        
        let endpoint = this.config.endpoints[name];
        
        if (!endpoint) {
            this.log(`‚ö†Ô∏è Endpoint '${name}' non trouv√© dans:`, Object.keys(this.config.endpoints));
            return null;
        }
        
        // Remplacer les placeholders dynamiques
        const currentDossier = this.getCurrentDossierId();
        endpoint = endpoint.replace(/\{dossier\}/g, currentDossier)
                          .replace(/\{dossierId\}/g, currentDossier)
                          .replace(/\{id\}/g, currentDossier);
        
        this.log(`üìç Endpoint '${name}':`, endpoint);
        return endpoint;
    },
    
    /**
     * ‚úÖ OBTENIR LA CONFIGURATION CHUNKING
     */
    getChunkingConfig() {
        if (!this.config.initialized) {
            this.initializeFromPhase2Config();
        }
        
        return this.config.chunking;
    },
    
    /**
     * ‚úÖ METTRE √Ä JOUR LES CONFIGURATIONS EXISTANTES - AM√âLIOR√â
     */
    updateExistingConfigs() {
        this.log('üîÑ Mise √† jour des configurations existantes v2.1...');
        
        // Mettre √† jour ChunkingConfig si pr√©sent
        if (window.ChunkingConfig && window.ChunkingConfig.endpoints) {
            const oldEndpoints = { ...window.ChunkingConfig.endpoints };
            
            window.ChunkingConfig.endpoints.processChunk = this.getEndpoint('processChunk');
            window.ChunkingConfig.endpoints.refreshCSRF = this.getEndpoint('refreshCSRF');
            window.ChunkingConfig.endpoints.healthCheck = this.getEndpoint('healthCheck');
            
            this.log('‚úÖ ChunkingConfig mis √† jour:', {
                ancien: oldEndpoints,
                nouveau: window.ChunkingConfig.endpoints
            });
        }
        
        // Mettre √† jour Workflow2Phases si pr√©sent
        if (window.Workflow2Phases && window.Workflow2Phases.config) {
            const oldRoutes = { ...window.Workflow2Phases.config.routes };
            
            if (this.getEndpoint('storePhase1')) {
                window.Workflow2Phases.config.routes.phase1 = this.getEndpoint('storePhase1');
            }
            if (this.getEndpoint('storeAdherents')) {
                window.Workflow2Phases.config.routes.phase2_template = this.getEndpoint('storeAdherents');
            }
            if (this.getEndpoint('confirmation')) {
                window.Workflow2Phases.config.routes.confirmation_template = this.getEndpoint('confirmation');
            }
            
            this.log('‚úÖ Workflow2Phases mis √† jour:', {
                ancien: oldRoutes,
                nouveau: window.Workflow2Phases.config.routes
            });
        }
        
        // √âmettre √©v√©nement global
        window.dispatchEvent(new CustomEvent('config-updated', {
            detail: { 
                endpoints: this.config.endpoints, 
                timestamp: Date.now(),
                version: this.config.version
            }
        }));
        
        this.log('üì° √âv√©nement config-updated √©mis');
    },
    
    /**
     * ‚úÖ VALIDATION DE LA CONFIGURATION
     */
    validateConfig() {
        const required = ['processChunk', 'storeAdherents', 'confirmation'];
        const missing = [];
        const invalid = [];
        
        required.forEach(endpoint => {
            const url = this.getEndpoint(endpoint);
            if (!url) {
                missing.push(endpoint);
            } else if (!url.startsWith('/') && !url.startsWith('http')) {
                invalid.push({ endpoint, url });
            }
        });
        
        if (missing.length > 0) {
            this.log('‚ùå Endpoints manquants:', missing);
        }
        if (invalid.length > 0) {
            this.log('‚ùå Endpoints invalides:', invalid);
        }
        
        const isValid = missing.length === 0 && invalid.length === 0;
        
        if (isValid) {
            this.log('‚úÖ Configuration valid√©e');
        }
        
        return {
            valid: isValid,
            missing,
            invalid
        };
    },
    
    /**
     * ‚úÖ MONITORING ET AUTO-CORRECTION
     */
    startMonitoring() {
        this.log('üîç D√©marrage monitoring configuration...');
        
        // V√©rification p√©riodique de Phase2Config
        const checkInterval = setInterval(() => {
            if (!this.config.initialized && window.Phase2Config) {
                this.log('üîÑ Phase2Config d√©tect√© tardivement, r√©initialisation...');
                this.initializeFromPhase2Config();
                clearInterval(checkInterval);
            }
        }, 2000);
        
        // Arr√™t automatique apr√®s 30 secondes
        setTimeout(() => {
            clearInterval(checkInterval);
            this.log('‚èπÔ∏è Monitoring configuration arr√™t√©');
        }, 30000);
    },
    
    /**
     * ‚úÖ DIAGNOSTIC DE LA CONFIGURATION - AM√âLIOR√â
     */
    diagnose() {
        const validation = this.validateConfig();
        
        const diagnostic = {
            version: this.config.version,
            initialized: this.config.initialized,
            phase2ConfigExists: !!window.Phase2Config,
            phase2ConfigUrls: window.Phase2Config?.urls ? Object.keys(window.Phase2Config.urls) : [],
            endpoints: this.config.endpoints,
            endpointsResolved: Object.keys(this.config.endpoints).reduce((acc, key) => {
                acc[key] = this.getEndpoint(key);
                return acc;
            }, {}),
            chunking: this.config.chunking,
            dossier: this.config.dossier,
            currentDossierId: this.getCurrentDossierId(),
            validation,
            timestamp: new Date().toISOString()
        };
        
        this.log('üîç Diagnostic configuration v2.1:', diagnostic);
        return diagnostic;
    },
    
    /**
     * ‚úÖ LOGGING
     */
    log(...args) {
        if (this.config.debug) {
            console.log('[UnifiedConfig]', ...args);
        }
    }
};

// Initialisation automatique avec monitoring
document.addEventListener('DOMContentLoaded', function() {
    // Initialisation imm√©diate
    window.UnifiedConfigManager.initializeFromPhase2Config();
    
    // D√©marrage du monitoring
    window.UnifiedConfigManager.startMonitoring();
    
    // Retry apr√®s d√©lai si Phase2Config n'√©tait pas pr√™t
    setTimeout(() => {
        if (!window.UnifiedConfigManager.config.initialized) {
            window.UnifiedConfigManager.log('üîÑ Retry initialisation...');
            window.UnifiedConfigManager.initializeFromPhase2Config();
        } else {
            // Forcer mise √† jour des autres configurations
            window.UnifiedConfigManager.updateExistingConfigs();
        }
        
        // Diagnostic final
        window.UnifiedConfigManager.diagnose();
    }, 1000);
});